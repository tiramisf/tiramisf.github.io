(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&l(d)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();let a=null,m=[],p=new vis.DataSet([]),C=new vis.DataSet([]),c={nodes:[],edges:[]},ye=!1,Ee=null,v=null,b=null,D=null,k=null,H,ve,h,Le,Ce,Ie,Be,j,K,Y,ie,de,I,J,W,S,oe,be,le,ke,L,z,B,f=null,V,q,De,$,ae,U,se,O,re,ce,xe,Q,Te,_,ue,M,ge,w,fe,he,Se;const X=["#FF0000","#FFA500","#FFFF00","#008000","#0000FF","#4B0082","#EE82EE","#FFFFFF","#000000"],s={nodeShape:"dot",nodeSize:20,nodeColor:X[4],nodeBorderColor:X[4],nodeTextColor:"#FFFFFF",nodeTextSize:60,edgeColor:"#848484",edgeWidth:1};let N=!1,G=!0;const Ae="#D3E5FF",Fe="#2B7CE9",He="#2B7CE9",Oe=.2,T=1,ze=0,Ne=0,Ge="transparent";function Je(t,n){let e=null;return(...o)=>{e!==null&&(clearTimeout(e),e=null),e=setTimeout(()=>t(...o),n)}}function ne(){const t={color:{color:s.edgeColor,highlight:He},arrows:"to",width:s.edgeWidth},n=G?{enabled:!0,type:"dynamic",roundness:.5}:{enabled:!1,type:"continuous"},e=G?{solver:"barnesHut",barnesHut:{gravitationalConstant:-12e3,centralGravity:.6,springLength:120,springConstant:.02,damping:.09,avoidOverlap:.3},minVelocity:.75,stabilization:{enabled:!0,iterations:1e3,updateInterval:50,fit:!1}}:{enabled:!1};return{nodes:{shape:s.nodeShape,size:s.nodeSize,font:{size:s.nodeTextSize,color:s.nodeTextColor},borderWidth:2,color:{background:s.nodeColor,border:s.nodeBorderColor,highlight:{background:Ae,border:Fe}},opacity:T},edges:{...t,smooth:n},physics:e,interaction:{hover:!0,tooltipDelay:200,selectConnectedEdges:!1},layout:{randomSeed:void 0,improvedLayout:!0},autoResize:!1}}function we(t,n,e,l,o={}){n.innerHTML="",e.forEach(i=>{const d=document.createElement("div");d.className="palette-swatch",d.style.backgroundColor=i,d.dataset.color=i,d.setAttribute("role","button"),d.setAttribute("aria-label",`Select color ${i}`),d.tabIndex=0,d.addEventListener("click",()=>{l==="nodeColor"?(s.nodeColor=i,o.updateBorder&&(s.nodeBorderColor=i)):l==="nodeTextColor"&&(s.nodeTextColor=i),t.style.backgroundColor=i,n.classList.add("hidden"),t.setAttribute("aria-expanded","false"),pe()}),d.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),d.click())}),n.appendChild(d)}),t.addEventListener("click",i=>{i.stopPropagation();const d=n.classList.toggle("hidden");t.setAttribute("aria-expanded",String(!d))}),t.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),t.click())}),document.addEventListener("click",i=>{!n.classList.contains("hidden")&&!n.contains(i.target)&&!t.contains(i.target)&&(n.classList.add("hidden"),t.setAttribute("aria-expanded","false"))})}function We(){if(console.log("Initializing app..."),H=document.getElementById("graphContainer"),ve=document.getElementById("fileInput"),h=document.getElementById("fileNameDisplay"),Le=document.getElementById("exportButton"),Ce=document.getElementById("resetViewButton"),Ie=document.getElementById("zoomInButton"),Be=document.getElementById("zoomOutButton"),j=document.getElementById("nodeShapeSelector"),K=document.getElementById("nodeSizeSlider"),Y=document.getElementById("textSizeSlider"),ie=document.getElementById("dimUnconnectedToggle"),de=document.getElementById("grayscaleToggle"),I=document.getElementById("fixNodesToggle"),J=document.getElementById("hideArrowsToggle"),W=document.getElementById("disablePhysicsToggle"),S=H.querySelector(".placeholder-text"),oe=document.getElementById("nodeColorDisplay"),be=document.getElementById("nodeColorPaletteContainer"),le=document.getElementById("textColorDisplay"),ke=document.getElementById("textColorPaletteContainer"),L=document.getElementById("nodeListPanelContainer"),z=document.getElementById("nodeListHeader"),B=document.getElementById("nodeList"),V=document.getElementById("detailsOverlayContainer"),q=document.getElementById("nodeDetailsPanelLeft"),De=document.getElementById("closeDetailsButtonLeft"),$=document.getElementById("keyInputLeft"),ae=document.getElementById("copyKeyButtonLeft"),U=document.getElementById("commentInputLeft"),se=document.getElementById("copyCommentButtonLeft"),O=document.getElementById("contentInputLeft"),re=document.getElementById("copyContentButtonLeft"),ce=document.getElementById("markdownPreviewLeft"),xe=document.getElementById("saveDetailsButtonLeft"),Q=document.getElementById("nodeDetailsPanelRight"),Te=document.getElementById("closeDetailsButtonRight"),_=document.getElementById("keyInputRight"),ue=document.getElementById("copyKeyButtonRight"),M=document.getElementById("commentInputRight"),ge=document.getElementById("copyCommentButtonRight"),w=document.getElementById("contentInputRight"),fe=document.getElementById("copyContentButtonRight"),he=document.getElementById("markdownPreviewRight"),Se=document.getElementById("saveDetailsButtonRight"),ve.addEventListener("change",je),Le.addEventListener("click",Qe),Ce.addEventListener("click",()=>{a==null||a.fit(),ee()}),Ie.addEventListener("click",()=>a==null?void 0:a.moveTo({scale:a.getScale()*1.2})),Be.addEventListener("click",()=>a==null?void 0:a.moveTo({scale:a.getScale()*.8})),j.addEventListener("change",Ye),K.addEventListener("input",pe),Y.addEventListener("input",pe),ie.addEventListener("change",()=>{c.nodes.length>0||c.edges.length>0?F(c.nodes,c.edges):R()}),de.addEventListener("change",Ve),I.addEventListener("change",qe),J.addEventListener("change",()=>{N=J.checked,R(),(c.nodes.length>0||c.edges.length>0)&&F(c.nodes,c.edges)}),W.addEventListener("change",()=>{G=!W.checked,a&&a.setOptions(ne())}),we(oe,be,X,"nodeColor",{updateBorder:!0}),we(le,ke,X,"nodeTextColor"),z.addEventListener("click",Xe),De.addEventListener("click",()=>Re("left")),xe.addEventListener("click",()=>me("left")),ae.addEventListener("click",()=>P("key","left")),se.addEventListener("click",()=>P("comment","left")),re.addEventListener("click",()=>P("content","left")),O.addEventListener("input",()=>{v!==null&&(ce.innerHTML=marked.parse(O.value))}),Te.addEventListener("click",()=>Re("right")),Se.addEventListener("click",()=>me("right")),ue.addEventListener("click",()=>P("key","right")),ge.addEventListener("click",()=>P("comment","right")),fe.addEventListener("click",()=>P("content","right")),w.addEventListener("input",()=>{D!==null&&(he.innerHTML=marked.parse(w.value))}),j.value=s.nodeShape,K.value=String(s.nodeSize),oe.style.backgroundColor=s.nodeColor,Y.value=String(s.nodeTextSize),le.style.backgroundColor=s.nodeTextColor,J.checked=N,W.checked=!G,h.textContent="No file chosen",Z(!1,!1),L.classList.add("hidden"),L.classList.remove("expanded"),typeof ResizeObserver<"u"){const t=Je(()=>{a&&a.setSize("100%","100%")},250);Ee=new ResizeObserver(n=>{n&&n.length>0&&t()}),Ee.observe(H)}$e(),console.log("App initialized.")}function Z(t,n){!t&&!n?V.classList.add("hidden"):V.classList.remove("hidden"),q.classList.toggle("hidden",!t),Q.classList.toggle("hidden",!n)}function A(t,n){let e,l,o,i,d=null;if(n==="left"?(e=$,l=U,o=O,i=ce,v=t):(e=_,l=M,o=w,i=he,D=t),t===null){e.value="",l.value="",o.value="",i.innerHTML="",n==="left"?b=null:k=null;return}const r=p.get(t);if(r&&r.originalData)d=r.originalData,e.value=d.key||"",l.value=d.comment||"",o.value=d.content||"",i.innerHTML=marked.parse(d.content||""),n==="left"?b=d:k=d;else{const u=m.find(g=>g.id===t||m.indexOf(g)===t);u?(d=u,e.value=d.key||"",l.value=d.comment||"",o.value=d.content||"",i.innerHTML=marked.parse(d.content||""),n==="left"?b=d:k=d):(e.value="",l.value="",o.value="",i.innerHTML="",n==="left"?b=null:k=null,console.warn(`Node data not found for ID: ${t} in panel ${n}`))}}async function Re(t){const n=t==="left"?b:k,e=t==="left"?$:_,l=t==="left"?U:M,o=t==="left"?O:w;if(n){const i=e.value!==(n.key||""),d=l.value!==(n.comment||""),r=o.value!==(n.content||"");(i||d||r)&&confirm("You have unsaved changes. Save them before closing?")&&await me(t)}t==="left"?(q.classList.add("hidden"),v=null,b=null):(Q.classList.add("hidden"),D=null,k=null),q.classList.contains("hidden")&&Q.classList.contains("hidden")&&V.classList.add("hidden")}async function me(t){var u,g;const n=t==="left"?v:D;let e=t==="left"?b:k;const l=t==="left"?$:_,o=t==="left"?U:M,i=t==="left"?O:w;if(!n||!e){console.warn(`No active node or original data for panel ${t}, cannot save.`);return}if(m.findIndex(E=>E.id!==void 0&&E.id===(e==null?void 0:e.id)||E===e)<0){const E=typeof n=="number"?n:parseInt(String(n),10);if(!isNaN(E)&&m[E]){if(!(m[E].key===e.key||m.indexOf(e)===E)){console.error("Critical error: Mismatch finding node's original data. Node ID:",n,"Original Data Ref:",e),alert("Error: Could not save changes due to data inconsistency. Please try reloading or re-adding the node.");return}}else{console.error("Critical error: Cannot find selected node's original data in allData for saving. Node ID:",n),alert("Error: Could not save changes due to data inconsistency. Please try reloading the data.");return}}e.key=l.value,e.comment=o.value,e.content=i.value,e.id===void 0&&typeof n=="number"&&(e.id=n);let r=(u=e.comment)==null?void 0:u.trim();!r&&((g=e.key)!=null&&g.trim())&&(r=e.key.split(",")[0].trim()),r||(r=`Untitled ${typeof n=="number"?n+1:n}`),p.update({id:n,label:r.length>30?r.substring(0,27)+"...":r,title:(e.comment||"No Comment").replace(/</g,"&lt;").replace(/>/g,"&gt;"),originalData:e}),_e(),ye=!0,console.log(`Node details saved for panel ${t}. Data is dirty. ID:`,n)}function P(t,n){let e,l;n==="left"?t==="key"?(e=$,l=ae):t==="comment"?(e=U,l=se):(e=O,l=re):t==="key"?(e=_,l=ue):t==="comment"?(e=M,l=ge):(e=w,l=fe);const o=e.value;o&&navigator.clipboard.writeText(o).then(()=>{const i=l.textContent;l.textContent="Copied!",setTimeout(()=>{l.textContent=i},1500)}).catch(i=>{console.error(`Failed to copy ${t} from ${n} panel: `,i),alert(`Failed to copy ${t}. See console for details.`)})}function je(t){const n=t.target;if(n.files&&n.files[0]){const e=n.files[0];h.textContent=e.name,h.style.color="#e0e0e0";const l=new FileReader;l.onload=o=>{var i;try{const d=(i=o.target)==null?void 0:i.result;if(!d){alert("File is empty or could not be read."),h.textContent="Error reading file",h.style.color="#ff6666";return}const r=JSON.parse(d);if(typeof r=="object"&&r!==null&&Array.isArray(r.data))m=r.data.map((u,g)=>({...u,id:u.id??g}));else if(Array.isArray(r))m=r.map((u,g)=>({...u,id:u.id??g}));else{alert("Invalid JSON format. Expected an array of entries or an object with a 'data' array."),h.textContent="Invalid JSON format",h.style.color="#ff6666";return}ye=!1,Ke()}catch(d){console.error("Error parsing JSON file:",d),alert(`Error parsing JSON file. Please ensure it's valid JSON.
`+d.message),h.textContent="Error parsing JSON",h.style.color="#ff6666"}},l.onerror=o=>{console.error("Error reading file:",o),alert("Error reading file."),h.textContent="Error reading file",h.style.color="#ff6666"},l.readAsText(e)}else h.textContent="No file chosen",h.style.color="#a0a0a0"}function Ke(){console.log("Processing data and rendering graph..."),ee();const t=[],n=[];m.forEach((e,l)=>{var d,r;e.id===void 0&&(e.id=l);let o=(d=e.comment)==null?void 0:d.trim();!o&&((r=e.key)!=null&&r.trim())&&(o=e.key.split(",")[0].trim()),o||(o=`Untitled ${l+1}`);const i=p.get(e.id);t.push({id:e.id,label:o.length>30?o.substring(0,27)+"...":o,title:(e.comment||"No Comment").replace(/</g,"&lt;").replace(/>/g,"&gt;"),originalData:e,fixed:(i==null?void 0:i.fixed)??{x:(I==null?void 0:I.checked)??!1,y:(I==null?void 0:I.checked)??!1},x:i==null?void 0:i.x,y:i==null?void 0:i.y})}),m.forEach(e=>{var o;const l=((o=e.content)==null?void 0:o.toLowerCase())||"";!l||e.id===void 0||m.forEach(i=>{var r;if(i.id===void 0||e.id===i.id)return;const d=((r=i.key)==null?void 0:r.split(","))||[];for(const u of d){const g=u.trim().toLowerCase();if(g){const E=g.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");if(new RegExp(`\\b${E}\\b`).test(l)){n.push({from:e.id,to:i.id,id:`${e.id}-${i.id}-${u.trim()}`});break}}}})}),p.clear(),C.clear(),p.add(t),C.add(n),S&&(S.style.display=t.length>0?"none":"block",S.textContent=t.length>0?"":"No data to display. Load a JSON file."),_e(),$e(),N&&R(),console.log("Data processed and graph rendered.")}function $e(){a&&(a.destroy(),a=null);const t={nodes:p,edges:C};try{a=new vis.Network(H,t,ne()),a.on("click",Ue),G?a.once("stabilizationIterationsDone",()=>{console.log("Stabilization iterations done, fitting network."),a&&a.fit()}):a&&a.fit()}catch(n){console.error("Error rendering graph:",n),S&&(S.textContent="Error rendering graph. See console for details.",S.style.display="block")}}function Ue(t){if(R(),c={nodes:t.nodes,edges:t.edges},te(t.nodes.length>0?t.nodes[0]:null),t.edges.length>0){const n=t.edges[0],e=C.get(n);if(e&&typeof e.from<"u"&&typeof e.to<"u"){v=e.from,D=e.to,A(v,"left"),A(D,"right"),Z(!0,!0);const{nodesToHighlight:l,edgesToHighlight:o}=Pe(null,n);F(l,o),c={nodes:l,edges:o},te(l)}else ee()}else if(t.nodes.length>0){v=t.nodes[0],D=null,A(v,"left"),A(null,"right"),Z(!0,!1);const{nodesToHighlight:n,edgesToHighlight:e}=Pe(v,null);F(n,e),c={nodes:n,edges:e}}else ee()}function Pe(t,n){let e=[],l=[];if(t!==null&&a){e.push(t);const o=a.getConnectedEdges(t);l.push(...o),o.forEach(i=>{const d=C.get(i);d&&(d.from!==t&&!e.includes(d.from)&&e.push(d.from),d.to!==t&&!e.includes(d.to)&&e.push(d.to))})}else if(n!==null){const o=C.get(n);o&&(l.push(n),typeof o.from<"u"&&!e.includes(o.from)&&e.push(o.from),typeof o.to<"u"&&!e.includes(o.to)&&e.push(o.to))}return{nodesToHighlight:e,edgesToHighlight:l}}function F(t,n){const e=p.getIds(),l=C.getIds(),o=[],i=[],d=ie.checked,r=s.nodeColor,u=s.nodeBorderColor,g=s.nodeTextColor,E=s.edgeColor;e.forEach(x=>{t.includes(x)?o.push({id:x,color:{background:Ae,border:Fe},opacity:T,font:{color:g}}):o.push({id:x,color:{background:r,border:u},opacity:d?Oe:T,font:{color:g}})}),l.forEach(x=>{const Me=n.includes(x),y={id:x};Me?(y.color={color:He},y.opacity=T,y.arrows="to",y.width=s.edgeWidth):N?(y.color={color:Ge},y.opacity=ze,y.arrows={to:{enabled:!1}},y.width=Ne):(y.color={color:E},y.opacity=d?Oe:T,y.arrows="to",y.width=s.edgeWidth),i.push(y)}),o.length>0&&p.update(o),i.length>0&&C.update(i)}function R(){const t=[];p.getIds().forEach(e=>{const l=p.get(e);t.push({id:e,shape:s.nodeShape,size:s.nodeSize,color:{background:s.nodeColor,border:s.nodeBorderColor},opacity:T,font:{size:s.nodeTextSize,color:s.nodeTextColor},fixed:l==null?void 0:l.fixed,x:l==null?void 0:l.x,y:l==null?void 0:l.y})}),t.length>0&&p.update(t);const n=[];C.getIds().forEach(e=>{N?n.push({id:e,color:{color:Ge},opacity:ze,arrows:{to:{enabled:!1}},width:Ne}):n.push({id:e,color:{color:s.edgeColor},opacity:T,arrows:"to",width:s.edgeWidth})}),n.length>0&&C.update(n)}function ee(){v=null,b=null,D=null,k=null,c={nodes:[],edges:[]},Z(!1,!1),A(null,"left"),A(null,"right"),te(null),L&&L.classList.contains("hidden"),R(),a==null||a.unselectAll()}function Ye(){s.nodeShape=j.value,a&&(a.setOptions(ne()),R(),(c.nodes.length>0||c.edges.length>0)&&F(c.nodes,c.edges))}function Ve(){H.classList.toggle("grayscale-active",de.checked)}function qe(){const t=I.checked,n=p.getIds().map(e=>({id:e,fixed:{x:t,y:t}}));n.length>0&&p.update(n)}function pe(){s.nodeSize=parseInt(K.value),s.nodeTextSize=parseInt(Y.value),a&&(a.setOptions(ne()),R(),(c.nodes.length>0||c.edges.length>0)&&F(c.nodes,c.edges))}function Qe(){if(m.length===0){alert("No data to export.");return}const t=JSON.stringify({data:m},null,2),n=new Blob([t],{type:"application/json"}),e=URL.createObjectURL(n),l=document.createElement("a");l.href=e,l.download="lorebook_export.json",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(e),ye=!1,console.log("Data exported. Data is clean."),alert("Data exported successfully!")}function _e(){if(!B||!L||!z)return;B.innerHTML="";const t=p.get({fields:["id","label"],order:"label"});if(t.length===0&&m.length===0){L.classList.add("hidden");return}L.classList.remove("hidden"),t.forEach(n=>{const e=document.createElement("li");e.textContent=n.label||`Node ${n.id}`,e.dataset.nodeId=String(n.id),e.draggable=!0,e.addEventListener("click",()=>Ze(n.id)),e.addEventListener("dragstart",et),e.addEventListener("dragover",tt),e.addEventListener("drop",nt),e.addEventListener("dragend",ot),B.appendChild(e)}),te(v)}function Xe(){if(L&&z){const t=L.classList.toggle("expanded");z.querySelector(".toggle-arrow").textContent=t?"▲":"▼"}}function Ze(t){Ue({nodes:[t],edges:[]})}function te(t){if(!B)return;const n=B.querySelectorAll("li"),e=new Set;t!==null&&(Array.isArray(t)?t:[t]).forEach(o=>e.add(String(o))),n.forEach(l=>{const o=l.dataset.nodeId;o&&e.has(o)?l.classList.add("selected"):l.classList.remove("selected")})}function et(t){f=t.target,f&&t.dataTransfer&&(t.dataTransfer.setData("text/plain",f.dataset.nodeId||""),t.dataTransfer.effectAllowed="move",setTimeout(()=>{f==null||f.classList.add("dragging")},0))}function tt(t){t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="move")}function nt(t){t.preventDefault();const n=t.target.closest("li");if(f&&n&&f!==n&&B.contains(n)){const e=n.getBoundingClientRect();t.clientY-e.top>e.height/2?B.insertBefore(f,n.nextSibling):B.insertBefore(f,n)}f==null||f.classList.remove("dragging"),f=null}function ot(t){t.target.classList.remove("dragging"),f=null}document.addEventListener("DOMContentLoaded",We);
